
import pandas as pd
import google.generativeai as genai
import json
import os
from tqdm import tqdm
import time

# --- CONFIGURAÇÃO ---

# Carregue a chave da API a partir de uma variável de ambiente.
# É mais seguro do que colocar a chave diretamente no código.

API_KEY = "AIzaSyD6gBnZZq1ET5oCXNcUPEUM_25Wnwbs1ng" 
genai.configure(api_key=API_KEY)

# Nome do arquivo de entrada (pode ser .xlsx ou .csv)
ARQUIVO_ENTRADA = r'C:\Users\Marcos\Desktop\Dellys NS\ofertas\products.xlsx' 

# Nome do arquivo de saída JSON
ARQUIVO_SAIDA = r'E:\Files\Trabalho\Fastlay\CodeXlsxGen\produtos_processados.json'

# Dicionário para cache, evitando chamadas repetidas para a API
cache_expansao = {}

def expandir_abreviacoes(nome_produto, model):
    """
    Usa a API do Gemini para expandir as abreviações em um nome de produto.
    Utiliza um cache para evitar chamadas duplicadas.
    """
    # 1. Verifica se o resultado já está no cache
    if nome_produto in cache_expansao:
        return cache_expansao[nome_produto]

    # 2. Se não estiver no cache, cria o prompt para a IA
    # O prompt é bem específico para garantir o formato da resposta.
    prompt = f"""
    Você é um especialista em catalogação de produtos. Sua única tarefa é reescrever a descrição do produto a seguir, expandindo TODAS as abreviações para suas palavras completas em português do Brasil.

    Regras Importantes:
    - Retorne APENAS a descrição final expandida.
    - Não adicione introduções como "Aqui está a descrição:" ou qualquer outro texto.
    - Mantenha a capitalização original o máximo possível.

    Exemplo 1:
    Entrada: "CORD T BONE SHORT VAC CG PATAGONIA"
    Saída: "Cordeiro T-Bone Short Vácuo Congelado Patagonia"

    Exemplo 2:
    Entrada: "BISC CHOC GOTAS BAUDUCCO 100G"
    Saída: "Biscoito Chocolate Gotas Bauducco 100 Gramas"

    Exemplo 3:
    Entrada: "REFRI COLA LT 350ML"
    Saída: "Refrigerante Cola Lata 350 Mililitros"
    
    Agora, expanda a seguinte descrição:
    Entrada: "{nome_produto}"
    Saída:
    """

    try:
        # 3. Chama a API do Gemini
        response = model.generate_content(prompt)
        nome_expandido = response.text.strip()

        # 4. Armazena o resultado no cache e o retorna
        cache_expansao[nome_produto] = nome_expandido
        return nome_expandido
    except Exception as e:
        print(f"\n[AVISO] Ocorreu um erro ao processar '{nome_produto}': {e}")
        print("Retornando o nome original para este item.")
        # Em caso de erro, retorna o nome original para não parar o script
        return nome_produto

def processar_planilha():
    """
    Função principal que lê a planilha, processa cada linha e salva o JSON.
    """
    print("Iniciando o processamento da planilha de produtos...")

    # Carrega o modelo do Gemini
    model = genai.GenerativeModel('gemini-2.5-flash')

    # Tenta ler o arquivo de entrada (suporta .xlsx e .csv)
    try:
        if ARQUIVO_ENTRADA.endswith('.xlsx'):
            df = pd.read_excel(ARQUIVO_ENTRADA)
        elif ARQUIVO_ENTRADA.endswith('.csv'):
            df = pd.read_csv(ARQUIVO_ENTRADA)
        else:
            print(f"ERRO: Formato de arquivo '{ARQUIVO_ENTRADA}' não suportado. Use .xlsx ou .csv.")
            return
    except FileNotFoundError:
        print(f"ERRO: Arquivo '{ARQUIVO_ENTRADA}' não encontrado.")
        print("Verifique se o nome do arquivo está correto e se ele está na mesma pasta do script.")
        return

    # Verifica se as colunas necessárias existem
    colunas_necessarias = ['product_code', 'product_name']
    if not all(col in df.columns for col in colunas_necessarias):
        print(f"ERRO: A planilha deve conter as colunas: {', '.join(colunas_necessarias)}.")
        return
        
    resultados_finais = []

    print(f"Encontrados {len(df)} produtos para processar.")

    # Itera sobre cada linha da planilha com uma barra de progresso (tqdm)
    for index, row in tqdm(df.iterrows(), total=df.shape[0], desc="Processando produtos"):
        codigo = row['product_code']
        nome_abreviado = str(row['product_name']) # Garante que é uma string

        if pd.isna(nome_abreviado) or not nome_abreviado.strip():
            nome_expandido = "" # Trata células vazias
        else:
            # Chama a função que usa a IA
            nome_expandido = expandir_abreviacoes(nome_abreviado, model)
        
        resultados_finais.append({
            'product_code': codigo,
            'product_name_expanded': nome_expandido
        })
        
        # Pequena pausa para não sobrecarregar a API com muitas requisições por minuto
        time.sleep(0.5) 

    # Salva os resultados em um arquivo JSON
    print(f"\nSalvando os resultados em '{ARQUIVO_SAIDA}'...")
    with open(ARQUIVO_SAIDA, 'w', encoding='utf-8') as f:
        json.dump(resultados_finais, f, ensure_ascii=False, indent=4)

    print("Processamento concluído com sucesso!")

# Executa a função principal
if __name__ == "__main__":
    processar_planilha()